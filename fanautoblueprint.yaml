action:
  - variables:
      binnen_sensor: !input indoor_humidity_sensor
      buiten_sensor: !input outdoor_humidity_sensor
      pm25_sensor_id: !input pm25_sensor
      binnen: "{{ states(binnen_sensor) | float }}"
      buiten: "{{ states(buiten_sensor) | float }}"
      pm25: "{{ states(pm25_sensor_id) | float }}"
      min_vocht: !input min_indoor_humidity
      max_buiten: !input max_outdoor_humidity
      pm_drempel: !input pm25_threshold
      verschil_drempel: !input humidity_diff_threshold
      override_switch: !input override_switch
      override_duur: !input override_duration
      override_actief: "{{ is_state(override_switch, 'on') }}"
      vocht_schaal: >
        {% if binnen < min_vocht %}
          0
        {% else %}
          {{ ((binnen - min_vocht) / (80 - min_vocht) * 60) }}
        {% endif %}
      buiten_factor: >
        {% if buiten > max_buiten %}
          0.5
        {% elif buiten > (max_buiten - 20) %}
          0.7
        {% else %}
          1.0
        {% endif %}
      boost_pm: >
        {% if pm25 < 10 %}
          0
        {% else %}
          {{ (pm25 / pm_drempel * 40) }}
        {% endif %}
      totaal: >
        {% set totaal = (vocht_schaal * buiten_factor) + boost_pm %}
        {{ [totaal, 100] | min | round(0) }}
      verschil: "{{ (binnen - buiten) | abs }}"
      logbericht: >
        Override: {{ override_actief }}, Binnen: {{ binnen }}%, Buiten: {{ buiten }}%, Verschil: {{ verschil }}%,
        PM2.5: {{ pm25 }} µg/m³, Vocht schaal: {{ vocht_schaal | round(1) }},
        Buiten factor: {{ buiten_factor }}, PM boost: {{ boost_pm | round(1) }},
        Ventilatie: {{ totaal }}%
  - service: input_text.set_value
    data:
      entity_id: !input log_sensor
      value: "{{ logbericht }}"
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ override_actief }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input ventilation_entity
            data:
              brightness_pct: 80
          - delay:
              minutes: !input override_duration
          - service: input_boolean.turn_off
            target:
              entity_id: !input override_switch
      - conditions:
          - condition: template
            value_template: "{{ verschil < verschil_drempel }}"
        sequence:
          - service: light.turn_off
            target:
              entity_id: !input ventilation_entity
      - conditions: []
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input ventilation_entity
            data:
              brightness_pct: "{{ totaal }}"